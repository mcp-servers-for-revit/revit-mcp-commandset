# MCP v3.0 轻量验证版测试计划

## 文档说明

**版本**: v3.0 轻量验证版
**目标**: 快速验证现有MCP功能的可用性
**原则**: 快速优先、兼顾覆盖
**适用**: Revit 2020-2025 + MCP插件

**场景优先级说明**:
- 🔴 **必测**: 核心功能验证，必须执行
- 🟡 **建议**: 深度验证，建议执行
- 🔵 **可选**: 边界和性能测试，时间允许时执行

## 测试总览

| 模块 | 命令 | 场景数 | 验证重点 |
|------|------|--------|----------|
| 信息获取 | get_revit_status | 3 | 基本状态查询 |
| 元素查询 | ai_element_filter | 13 | 过滤和节点数据验证（含名称关键字） |
| 视觉操作 | operate_element_visual | 7 | 选择、着色和组合操作 |
| 可见性控制 | operate_element_visibility | 6 | 隐藏和隔离 |
| 几何变换 | operate_element_transform | 9 | 旋转、镜像、翻转、移动、复制 |
| 参数修改 | operate_element_modify | 7 | 参数设置、删除和中文支持 |
| 元素创建 | create_element | 10 | 基本创建功能 |
| 创建建议 | get_element_creation_suggestion | 5 | 参数建议查询 |
| 端到端验证 | 跨命令流程 | 6 | 组合操作流程 |
| **总计** | **8个MCP命令** | **66个** | **全功能覆盖** |

## 前置准备

### 环境检查

| 检查项 | 要求 | 状态 | 补充方法 |
|--------|------|------|----------|
| Revit版本 | 2020-2025任一版本 | □ | 启动Revit确认 |

### 元素准备

| 元素 | 数量 | 状态 | 快速创建方法 |
|------|------|------|-------------|
| 楼板 | 1块 | □ | 建筑→楼板→矩形 |
| 墙体 | 1面 | □ | 建筑→墙→直线 |
| 门 | 1扇 | □ | 建筑→门→点击墙 |
| 窗 | 1扇 | □ | 建筑→窗→点击墙 |
| 灯具(WorkPlaneBased) | 1个 | □ | 族库→M_吸顶灯→楼板 |
| Pin元素 | 1个 | □ | 选设备→右键→锁定（**说明**：Pin是Revit中的锁定状态，Pin后的元素无法被移动、旋转、镜像等变换操作） |
| 3D视图 | 1个 | □ | 视图→三维视图 |

## 测试执行记录

**使用说明**: 每完成一个场景，在对应行记录结果（✅成功 / ❌失败）

**记录格式**:
- ✅ 功能正常，符合预期
- ❌ 功能异常，记录问题到备注
- ⚠️ 部分功能异常，不影响核心

---

## AM - 信息查询模块

### 1. 信息获取模块（get_revit_status）

| 场景ID | 优先级 | 预期结果 | 测试结果 | 备注 |
|--------|--------|----------|----------|------|
| RS-01 | 🔴必测 | 返回当前项目信息 | □ | |
| RS-02 | 🟡建议 | 返回无活动文档状态 | □ | |
| RS-03 | 🟡建议 | 返回所有项目列表 | □ | |

### 2. 元素查询模块（ai_element_filter）

| 场景ID | 优先级 | 预期结果 | 测试结果 | 备注 |
|--------|--------|----------|----------|------|
| F-01 | 🔴必测 | 返回所有墙体 | □ | 验证identity节点存在 |
| F-02 | 🔴必测 | 返回指定墙体详情 | □ | 验证精确匹配 |
| F-03 | 🔴必测 | 返回范围内元素 | □ | 验证空间过滤 |
| F-04 | 🔴必测 | 仅返回可见元素 | □ | 切换视图验证 |
| F-05 | 🔴必测 | 仅返回类型 | □ | 验证type/instance区分 |
| F-06 | 🔴必测 | 返回高度参数 | □ | 验证参数提取+内置参数 |
| F-07 | 🔴必测 | 返回错误或空结果 | □ | 验证无效ID处理 |
| F-08 | 🟡建议 | 仅返回几何节点 | □ | **核对要点**：location含point/line，坐标为mm（内部ft×304.8）；**需对照示例值**：如墙体location.line.p0={x:1000, y:2000, z:0}(mm)，验证从内部ft转换 |
| F-09 | 🟡建议 | 返回identity+geometry完整节点 | □ | **核对要点**：包含name、category、elementId、location、boundingBox字段；**需对照示例值**：identity.name="基本墙-200mm"，geometry.boundingBox含min/max点 |
| F-10 | 🟡建议 | 返回嵌套参数结构 | □ | **核对要点**：parameters.instance和parameters.type两个子节点分别存在；**需对照示例值**：parameters.instance.高度=3000，parameters.type.功能=1，确认嵌套结构正确 |
| F-11 | 🟡建议 | 返回空列表，Success=true | □ | **验证空结果也是成功响应** |
| F-12 | 🔴必测 | 根据类型名关键字过滤元素 | □ | **操作步骤**：1) 先执行F-01查询墙体，记录第一个墙的类型名（如"常规-300mm"）；2) 提取关键字（如"300"或"常规"）；3) 使用filterNameKeyword过滤，验证能返回该墙体 |
| F-13 | 🔴必测 | 根据族名关键字过滤族实例 | □ | **操作步骤**：1) 先执行F-01查询门实例，记录族名（如"单扇-平齐"）；2) 提取关键字（如"单扇"）；3) 使用filterNameKeyword+filterCategory="OST_Doors"过滤，验证能返回该门 |

### 3. 视觉操作模块（operate_element_visual）

| 场景ID | 优先级 | 预期结果 | 测试结果 | 备注 |
|--------|--------|----------|----------|------|
| V-01 | 🔴必测 | Revit中墙体被选中 | □ | **测试对象**：使用F-01查询到的墙体ID；**验证方法**：在Revit界面检查是否有墙体被蓝色高亮选中，或通过"修改"功能区是否激活判断 |
| V-02 | 🔴必测 | 3D剖切框聚焦元素 | □ | **前置条件**：切换到3D视图；**测试对象**：使用F-01查询到的第一面墙；**验证方法**：检查3D视图是否自动调整剖切框将该墙体框选并居中显示 |
| V-03 | 🔴必测 | 元素高亮闪烁 | □ | **测试对象**：使用F-01查询到的任一墙体；**验证方法**：观察墙体是否出现短暂的红色高亮闪烁效果(持续约1-2秒) |
| V-04 | 🔴必测 | 元素显示红色 | □ | **测试对象**：使用F-01查询到的墙体；**验证方法**：检查墙体颜色是否覆盖为红色(默认[255,0,0])；**注意**：此为视图临时覆盖，不修改元素属性 |
| V-05 | 🔴必测 | 元素半透明 | □ | **测试对象**：使用F-01查询到的墙体；**验证方法**：检查墙体是否变为半透明状态(默认透明度50%)，可透视看到后面的元素；**注意**：此为视图临时覆盖 |
| V-06 | 🟡建议 | 有效元素成功，记录失败ID | □ | **测试场景**：提供3个元素ID，其中1-2个为无效ID(如999999)；**验证要点**：有效元素应成功执行视觉操作，failedElements数组应包含无效ID及失败原因 |
| V-07 | 🟡建议 | 颜色和透明度同时生效 | □ | **测试对象**：使用F-01中查询到的第一面墙；**操作步骤**：先执行SetColor使墙体显示为红色，再执行SetTransparency设置透明度；**验证方法**：墙体应同时呈现红色+半透明效果 |

---

## PM - 控制操作模块

### 4. 可见性控制模块（operate_element_visibility）

| 场景ID | 优先级 | 预期结果 | 测试结果 | 备注 |
|--------|--------|----------|----------|------|
| VI-01 | 🔴必测 | 元素在当前视图隐藏 | □ | **操作**：Hide操作；**测试对象**：使用F-01查询到的墙体；**验证方法**：墙体在当前视图不可见，切换到其他视图仍隐藏（持久隐藏）；**恢复方法**：需要Unhide操作才能恢复 |
| VI-02 | 🔴必测 | 元素临时隐藏 | □ | **操作**：TempHide操作；**测试对象**：使用F-01查询到的墙体；**验证方法**：墙体临时不可见，切换视图后自动恢复；**区别**：与VI-01不同，这是临时性隐藏 |
| VI-03 | 🔴必测 | 仅显示目标元素 | □ | **操作**：Isolate操作；**测试对象**：选择2-3个墙体ID；**验证方法**：只有指定墙体可见，其他所有元素被隐藏；**适用场景**：专注检查特定构件 |
| VI-04 | 🔴必测 | 恢复隐藏元素 | □ | **前置条件**：先执行VI-01使元素隐藏；**操作**：Unhide操作；**验证方法**：被Hide的元素重新可见；**注意**：仅对Hide有效，不影响TempHide |
| VI-05 | 🔴必测 | 恢复所有元素可见 | □ | **前置条件**：先执行VI-03隔离显示部分元素；**操作**：ResetIsolate操作；**验证方法**：所有元素恢复可见，视图恢复到隔离前的正常状态 |
| VI-06 | 🟡建议 | 返回参数错误 | □ | **测试场景**：提供空的元素ID数组或无效操作类型；**验证要点**：应返回明确的参数错误信息，而不是执行失败 |

### 5. 几何变换模块（operate_element_transform）

| 场景ID | 优先级 | 预期结果 | 测试结果 | 备注 |
|--------|--------|----------|----------|------|
| T-01 | 🔴必测 | 灯具方向改变90度 | □ | **轴线定义**：rotateAxis取灯具中心垂直轴（p0=灯具location点，p1=location点向上偏移1000mm），rotateAngle=90（逆时针），如宿主约束无法旋转则记录跳过 |
| T-02 | 🟡建议 | 家具X坐标变为相反数，Y/Z坐标保持不变 | □ | **镜像平面**：origin=家具boundingBox中心点，normal={1,0,0}（YZ平面通过家具中心） |
| T-03 | 🔴必测 | 门水平翻转 | □ | 检查门朝向 |
| T-04 | 🔴必测 | 门前后翻转 | □ | 检查门朝向 |
| T-05 | 🔴必测 | 元素X方向移动1米 | □ | 检查位置变化 |
| T-06 | 🟡建议 | Pin元素操作失败，记录原因 | □ | 验证Pin状态处理 |
| T-07 | 🔵可选 | 返回参数错误 | □ | 验证参数检查 |
| T-08 | 🔵可选 | 返回参数错误或无变化 | □ | 验证零向量处理 |
| T-09 | 🔴必测 | 元素被复制，X方向偏移2米 | □ | 验证返回copiedElements数组包含新元素ID |

### 6. 参数修改模块（operate_element_modify）

| 场景ID | 优先级 | 预期结果 | 测试结果 | 备注 |
|--------|--------|----------|----------|------|
| M-01 | 🔴必测 | 参数值更新 | □ | **操作**：SetParameter操作；**测试对象**：使用F-01查询到的墙体；**测试参数**：修改"注释"参数（文本类型）为任意文本；**验证方法**：选中墙体，在属性面板检查"注释"参数值已更新 |
| M-02 | 🔴必测 | 参数值正确转换（mm→ft） | □ | **操作**：SetParameter操作；**测试对象**：使用F-01查询到的墙体；**测试参数**：修改"无约束高度"参数，传入毫米值（如4000mm）；**验证方法**：检查实际墙体高度是否正确转换并应用 |
| M-03 | 🟡建议 | 内置参数设置成功 | □ | **操作**：SetParameter操作，isBuiltIn=true；**测试对象**：使用F-01查询到的墙体；**测试参数**：使用内置参数名（如"WALL_USER_HEIGHT_PARAM"）修改高度；**验证方法**：检查参数值更新成功 |
| M-04 | 🟡建议 | 操作失败，记录原因 | □ | **测试场景**：尝试修改只读参数（如"体积"、"面积"等计算类参数）；**验证要点**：操作应失败，failedElements应包含该元素ID及"参数只读"的失败原因 |
| M-05 | 🟡建议 | 操作失败，记录未找到 | □ | **测试场景**：使用不存在的参数名（如"不存在的参数123"）；**验证要点**：操作应失败，failedElements应包含"参数未找到"的失败原因 |
| M-06 | 🔴必测 | 元素删除成功 | □ | **操作**：Delete操作；**测试对象**：使用C-01中创建的临时墙体（避免删除项目重要元素）；**验证方法**：在Revit中确认该元素已消失，无法通过F-02查询到该ID |
| M-07 | 🟡建议 | 参数值更新 | □ | **操作**：SetParameter操作；**测试对象**：使用C-01中创建的墙体；**测试参数**：使用中文参数名（如"注释"、"无约束高度"）；**验证要点**：验证中文参数名正确识别和设置 |

---

## AM - 创建模块

### 7. 元素创建模块（create_element）

| 场景ID | 优先级 | 预期结果 | 测试结果 | 备注 |
|--------|--------|----------|----------|------|
| C-01 | 🔴必测 | 新墙体生成 | □ | **元素类型**：System族-墙体；**必需信息**：墙体类型ID、起点终点坐标（line）、高度；**验证方法**：检查墙体是否按指定位置和高度创建，类型是否正确；**保留用途**：用于M-06、M-07测试 |
| C-02 | 🔴必测 | 新楼板生成 | □ | **元素类型**：System族-楼板；**必需信息**：楼板类型ID、边界点数组（至少3个点形成闭合区域）；**验证方法**：检查楼板是否按指定边界创建，边界是否闭合 |
| C-03 | 🔴必测 | 门放置到墙上 | □ | **元素类型**：Family族-门（OneLevelBasedHosted）；**必需信息**：门类型ID、放置点坐标、宿主墙ID；**验证方法**：检查门是否正确放置在墙上，朝向是否合理 |
| C-04 | 🔴必测 | 设备放置成功 | □ | **元素类型**：Family族-机电设备（OneLevelBased）；**必需信息**：设备类型ID、放置点坐标；**验证方法**：检查设备是否在指定位置创建，标高是否正确 |
| C-05 | 🟡建议 | 自动选择最近标高 | □ | **测试场景**：创建元素时不指定levelId，autoFindLevel=true；**验证要点**：系统应根据locationPoint的Z坐标自动选择最近的标高 |
| C-06 | 🟡建议 | 自动绑定合适宿主 | □ | **测试场景**：创建门时不指定hostElementId，autoFindHost=true，提供放置点坐标；**验证要点**：系统应在searchRadius范围内自动查找最近的墙体作为宿主 |
| C-07 | 🟡建议 | 创建失败，错误提示 | □ | **测试场景**：使用不存在的typeId（如999999）或错误的elementClass；**验证要点**：应返回明确的"类型不存在"或"类型不匹配"错误信息 |
| C-08 | 🟡建议 | 创建失败，参数错误 | □ | **测试场景**：楼板边界只提供2个点（不足3个）或边界不闭合；**验证要点**：应返回"边界无效"或"点数不足"的错误信息 |
| C-09 | 🔵可选 | 族放置方向正确 | □ | **测试场景**：创建WorkPlaneBased族实例（如灯具），提供handDirection和faceDirection；**验证要点**：检查族实例的朝向是否符合指定的方向向量 |
| C-10 | 🔵可选 | 全部创建成功，耗时<3秒 | □ | **测试场景**：批量创建10个相同类型的设备或墙体；**验证要点**：所有元素成功创建，总耗时应在3秒内，验证批量创建性能 |

### 8. 创建建议模块（get_element_creation_suggestion）

| 场景ID | 优先级 | 预期结果 | 测试结果 | 备注 |
|--------|--------|----------|----------|------|
| GS-01 | 🔴必测 | 返回所有创建建议 | □ | **查询参数**：returnAll=true；**验证要点**：应返回完整的参数格式指南，包括Family和System两大类的所有创建参数说明、可选参数、示例值 |
| GS-02 | 🔴必测 | 返回墙体创建参数说明 | □ | **查询参数**：elementType="wall"；**验证要点**：应返回墙体创建所需的line、height等必需参数说明，以及baseOffset等可选参数，帮助AI理解墙体创建需求 |
| GS-03 | 🔴必测 | 返回楼板创建参数说明 | □ | **查询参数**：elementType="floor"；**验证要点**：应返回楼板创建所需的boundary点数组要求（至少3个点）、thickness等参数说明 |
| GS-04 | 🟡建议 | 返回族创建参数说明 | □ | **查询参数**：elementClass="Family"；**验证要点**：应返回族实例的8种放置类型说明、locationPoint/locationLine要求、宿主参数、方向参数等完整指导 |
| GS-05 | 🟡建议 | 返回对应类别建议 | □ | **查询参数**：elementId=某个墙体或族实例的ID；**验证要点**：系统应自动分析该元素类型，返回对应的创建参数建议（如墙体则返回GS-02内容，门则返回族建议） |

---

## PM - 综合验证

### 9. 端到端验证（跨命令流程）

| 场景ID | 优先级 | 操作要点 | 预期结果 | 测试结果 | 备注 |
|--------|--------|----------|----------|----------|------|
| E-01 | 🔴必测 | 数据流验证：查询墙体geometry→基于坐标进行视觉标记 | 坐标数据被正确消费 | □ | **必须记录**：location坐标值与实际选中位置一致性 |
| E-02 | 🟡建议 | 创建临时墙→查询验证→删除清理 | 创建删除循环成功 | □ | **操作流程**：①使用create_element创建一面临时墙；②使用ai_element_filter根据创建返回的ID查询该墙体，验证数据正确；③使用operate_element_modify的Delete操作删除该墙；**验证要点**：完整的CRUD闭环，验证数据一致性 |
| E-03 | 🟡建议 | 隔离结构墙→批量调整位置→恢复显示 | 隔离状态下的批量操作 | □ | **操作流程**：①使用ai_element_filter查询结构墙（filterCategory="OST_Walls"，可结合filterNameKeyword="结构"）；②使用operate_element_visibility的Isolate操作隔离显示这些墙；③使用operate_element_transform的Move操作批量移动；④使用ResetIsolate恢复显示；**验证要点**：可见性控制与几何变换的组合使用 |
| E-04 | 🟡建议 | 获取门窗建议→批量创建→检查朝向 | 建议指导标准化创建 | □ | **操作流程**：①使用get_element_creation_suggestion查询族实例创建参数要求；②根据返回的参数建议，使用create_element批量创建3-5个门或窗实例；③使用operate_element_transform的Flip操作调整朝向；**验证要点**：建议命令是否有效指导AI完成创建 |
| E-05 | 🟡建议 | 查找超高构件→红色标记→导出列表 | 批量问题标记流程 | □ | **操作流程**：①使用ai_element_filter查询墙体，获取parameters节点中的高度参数；②筛选出高度>5000mm的墙体；③使用operate_element_visual的SetColor操作将这些墙体标记为红色；④记录这些元素的ID和高度形成问题列表；**验证要点**：典型的问题检查和标记工作流 |
| E-06 | 🔵可选 | Pin元素操作失败→自动跳过→继续处理 | 容错机制正常 | □ | **前置条件**：准备1个Pin元素（锁定状态）和2个普通元素；**操作流程**：对这3个元素执行operate_element_transform的Move操作；**验证要点**：Pin元素应出现在failedElements中并记录失败原因，其他2个元素成功移动，整体操作不中断 |

---

## 测试结果汇总

### 模块通过率统计

| 模块 | 总场景 | 通过 | 失败 | 通过率 | 状态 |
|------|--------|------|------|--------|------|
| 信息获取 | 3 | _ | _ | _% | □ |
| 元素查询 | 13 | _ | _ | _% | □ |
| 视觉操作 | 6 | _ | _ | _% | □ |
| 可见性控制 | 6 | _ | _ | _% | □ |
| 几何变换 | 9 | _ | _ | _% | □ |
| 参数修改 | 6 | _ | _ | _% | □ |
| 元素创建 | 10 | _ | _ | _% | □ |
| 创建建议 | 5 | _ | _ | _% | □ |
| 端到端验证 | 6 | _ | _ | _% | □ |
| **总计** | **66** | **_** | **_** | **_%** | □ |

### 成功标准

- ✅ **功能可用**: 各模块通过率 ≥ 80%
- ✅ **响应合理**: 单操作耗时 < 5秒
- ✅ **错误可控**: 异常场景有明确提示
- ✅ **节点完整**: 返回数据包含4个核心节点

### 问题记录

| 问题ID | 场景ID | 问题描述 | 严重程度 | 解决建议 |
|--------|--------|----------|----------|----------|
| | | | 高/中/低 | |
| | | | | |
| | | | | |

### 执行总结

**测试环境**:
- Revit版本: _______
- MCP插件版本: _______
- 测试日期: _______
- 执行人员: _______

**整体评价**:
- □ 功能基本可用，建议发布
- □ 功能存在问题，需要修复
- □ 功能严重缺陷，不建议使用

**后续建议**:
- □ 继续进行性能测试
- □ 添加自动化脚本
- □ 补充边界条件测试
- □ 多版本兼容性测试

---

## 附录

### 快速故障排除

**常见问题及解决方法**:

1. **MCP命令无响应**
   - 检查外部工具是否正确加载
   - 重启Revit并重新加载插件

2. **参数设置失败**
   - 确认参数名称正确（注意中英文）
   - 检查参数是否为只读

3. **元素创建失败**
   - 验证typeId是否存在于项目中
   - 检查创建位置是否有冲突

4. **数据返回不完整**
   - 检查fields参数设置
   - 验证元素是否在当前视图可见

### 单位转换对照表

| 类型 | Revit内部单位 | 显示单位 | 转换系数 |
|------|-------------|----------|----------|
| 长度 | 英尺(ft) | 毫米(mm) | 1 ft = 304.8 mm |
| 角度 | 弧度(rad) | 度(°) | 1 rad = 57.2958° |
| 面积 | 平方英尺(ft²) | 平方米(m²) | 1 ft² = 0.092903 m² |

### 坐标系统说明

```
Revit坐标系统：
- X轴：东西方向（正X为东）
- Y轴：南北方向（正Y为北）
- Z轴：高程方向（正Z向上）
- 原点：项目基点或内部原点

单位：所有API返回的坐标值为毫米(mm)
```

### 节点验证Checklist

**identity节点**：
- [ ] name（元素名称）
- [ ] category（类别名称）
- [ ] elementId（元素ID）

**type节点**：
- [ ] typeId（类型ID）
- [ ] typeName（类型名称）
- [ ] familyId（族ID，仅族实例）
- [ ] familyName（族名称，仅族实例）

**geometry节点**：
- [ ] location.point 或 location.line
- [ ] boundingBox.min/max坐标
- [ ] 坐标值为毫米单位

**parameters节点**：

- [ ] instance子节点（实例参数）
- [ ] type子节点（类型参数，如果requested）
- [ ] 参数值类型正确

### E-01数据流验证详细步骤

1. **查询阶段**：
   ```json
   ai_element_filter({
     "data": {
       "filterCategory": "OST_Walls",
       "fields": ["identity", "geometry.location"]
     }
   })
   ```

2. **记录坐标**：
   ```
   记录第一面墙的geometry.location.line:
   p0: {x: ____, y: ____, z: ____}
   p1: {x: ____, y: ____, z: ____}
   ```

3. **视觉标记**：
   
   ```json
   operate_element_visual({
     "data": {
       "elementIds": [从步骤1获取的wallId],
       "visualAction": "Highlight"
     }
   })
   ```
   
4. **验证一致性**：
   ```
   □ 高亮的墙体位置与记录坐标一致
   □ 坐标值确为毫米单位
   □ 数据传递无错误
   ```

---

**文档版本**: v3.0 轻量版（最终修订）
**最后更新**: 2024年9月29日
**文档作者**: Claude AI Assistant
**审核状态**: 已根据专家建议完善